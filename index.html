<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puter AI Dashboard</title>
    <!-- Load Puter v2 -->
    <script src="https://js.puter.com/v2/"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --border: #334155;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --accent: #3b82f6;
            --success: #10b981;
            --error: #ef4444;
            --font-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Header & Status --- */
        h1 { margin: 0 0 20px 0; font-weight: 300; letter-spacing: 1px; }

        #login-btn {
            background: var(--accent); color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-weight: bold; margin-bottom: 20px; display: none;
        }

        /* --- Log Container --- */
        #logs-container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- The Log Card --- */
        .log-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Header */
        .card-header {
            padding: 12px 16px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badges { display: flex; gap: 10px; align-items: center; }
        
        .badge {
            font-size: 0.75rem; padding: 4px 8px; border-radius: 4px;
            font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .b-model { background: #172554; color: #93c5fd; border: 1px solid #1e40af; }
        .b-time { background: #064e3b; color: #6ee7b7; border: 1px solid #065f46; font-family: var(--font-mono); }
        .b-time.pending { background: #451a03; color: #fdba74; border-color: #9a3412; }
        .b-error { background: #450a0a; color: #fca5a5; border-color: #991b1b; }

        .req-id { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-sub); }

        /* --- Spoilers (Details/Summary) --- */
        details { border-bottom: 1px solid var(--border); transition: background 0.2s; }
        details:last-child { border-bottom: none; }
        details[open] { background: rgba(255,255,255,0.02); }

        summary {
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
            align-items: center;
            outline: none;
        }
        summary:hover { color: var(--text-main); }
        summary::-webkit-details-marker { display: none; }
        
        /* Custom arrow/indicator */
        summary::before {
            content: "►"; display: inline-block; margin-right: 8px; font-size: 0.8em; transition: transform 0.2s;
        }
        details[open] summary::before { transform: rotate(90deg); color: var(--accent); }

        .meta-tag { font-family: var(--font-mono); font-size: 0.75rem; opacity: 0.8; }

        /* Content Box */
        .content-box {
            padding: 16px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap; /* Preserve formatting */
            color: #e2e8f0;
            background: #0b1120;
            max-height: 400px;
            overflow-y: auto;
            border-top: 1px solid var(--border);
        }

        /* Images */
        .req-img {
            display: block; margin-top: 10px;
            max-width: 150px; border-radius: 4px; border: 1px solid var(--border);
        }
    </style>
</head>
<body>

    <h1>Playwright Dashboard</h1>

    <!-- Manual Login Button (Visible only if needed) -->
    <button id="login-btn" onclick="puter.auth.signIn()">⚠ Login Required</button>

    <div id="logs-container">
        <!-- Logs appear here dynamically -->
    </div>

    <script>
        const container = document.getElementById('logs-container');
        const loginBtn = document.getElementById('login-btn');

        // 1. UI Helper: Create the Card
        function createLogCard(id, prompt, model, imageSrc) {
            const card = document.createElement('div');
            card.className = 'log-card';
            card.id = id;

            let imgHtml = '';
            if (imageSrc) {
                imgHtml = `<img src="${imageSrc}" class="req-img" title="Input Image">`;
            }

            card.innerHTML = `
                <div class="card-header">
                    <div class="badges">
                        <span class="badge b-model">${model}</span>
                        <span class="badge b-time pending" id="${id}-timer">PROCESSING...</span>
                    </div>
                    <div class="req-id">ID: ${id.split('-').pop()}</div>
                </div>

                <!-- 1. REQUEST -->
                <details open>
                    <summary>
                        <span>Input Request</span>
                        <span class="meta-tag">Len: ${prompt.length} chars</span>
                    </summary>
                    <div class="content-box">${escapeHtml(prompt)}${imgHtml}</div>
                </details>

                <!-- 2. RESPONSE -->
                <details id="${id}-out-details">
                    <summary>
                        <span>AI Response</span>
                        <span class="meta-tag" id="${id}-out-len">Waiting...</span>
                    </summary>
                    <div class="content-box" id="${id}-out-content"></div>
                </details>
            `;
            
            // Insert at top
            container.insertBefore(card, container.firstChild);
        }

        // 2. UI Helper: Update Card on Success
        function updateSuccess(id, text, duration) {
            const timer = document.getElementById(`${id}-timer`);
            const content = document.getElementById(`${id}-out-content`);
            const lenTag = document.getElementById(`${id}-out-len`);
            const details = document.getElementById(`${id}-out-details`);

            timer.className = 'badge b-time';
            timer.innerText = `${duration}s`;

            content.innerText = text;
            lenTag.innerText = `Len: ${text.length} chars`;
            
            // Auto open response
            details.open = true;
        }

        // 3. UI Helper: Update Card on Error
        function updateError(id, err, duration) {
            const timer = document.getElementById(`${id}-timer`);
            const content = document.getElementById(`${id}-out-content`);
            const details = document.getElementById(`${id}-out-details`);

            timer.className = 'badge b-error';
            timer.innerText = `${duration}s (FAIL)`;

            content.style.color = 'var(--error)';
            content.innerText = "Error: " + err.message;
            details.open = true;
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // --- THE MAGIC: INTERCEPTING PUTER.AI ---
        window.addEventListener('load', () => {
            
            // Check auth state for button visibility
            if(!puter.auth.isSignedIn()) {
                loginBtn.style.display = 'block';
            }

            // Save original function
            const originalChat = puter.ai.chat;

            // Overwrite function
            puter.ai.chat = async function(arg1, arg2, arg3) {
                const startTime = Date.now();
                const reqId = 'req-' + startTime;

                // --- Argument Parsing Logic ---
                // Puter calls can be:
                // 1. chat(prompt, options)
                // 2. chat(prompt, image, options)
                
                let prompt = arg1;
                let image = null;
                let options = {};

                // Detect if 2nd arg is image (string or object, usually dataURI string)
                if (arg2 && typeof arg2 === 'string' && arg2.startsWith('data:')) {
                    image = arg2;
                    options = arg3 || {};
                } else {
                    options = arg2 || {};
                }
                
                const model = options.model || 'Default';

                // 1. Render UI immediately
                createLogCard(reqId, prompt, model, image);

                try {
                    // 2. Call the REAL function
                    const response = await originalChat.call(puter.ai, arg1, arg2, arg3);

                    // 3. Calculate Stats
                    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                    
                    let cleanText = "";
                    if (response?.message?.content) {
                        cleanText = response.message.content;
                    } else {
                        cleanText = JSON.stringify(response, null, 2);
                    }

                    // 4. Update UI
                    updateSuccess(reqId, cleanText, duration);

                    // 5. Return result to Python
                    return response;

                } catch (err) {
                    // Handle Errors
                    const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                    updateError(reqId, err, duration);
                    throw err; // Ensure Python gets the error
                }
            };
            
            console.log("Puter AI Interceptor Active");
        });
    </script>
</body>
</html>